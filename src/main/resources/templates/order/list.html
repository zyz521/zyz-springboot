<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æˆ‘çš„è®¢å• - äºŒæ‰‹é±¼å¡˜</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background: #fff7e0;
        }
        .brand-bg {
            background: linear-gradient(90deg, #ffb300, #ff8a00);
        }
        .order-card {
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 6px 20px rgba(0,0,0,.08);
            padding: 16px;
        }
        .status-tag {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(255,255,255,.2);
            color: #fff;
        }
        .delete-btn {
            color: #ff6b6b;
            background: none;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #fff5f5;
        }
        /* ç°ä»£ç®€çº¦é£æ ¼åˆ é™¤ç¡®è®¤å¼¹çª— */
        .confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .confirm-backdrop.show {
            display: flex;
        }
        .confirm-dialog {
            width: 78%;
            max-width: 360px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            padding: 18px 18px 12px;
        }
        .confirm-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .confirm-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
        }
        .confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .confirm-btn {
            border-radius: 999px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-btn-cancel {
            background: #f5f5f5;
            color: #666;
        }
        .confirm-btn-cancel:hover {
            background: #e8e8e8;
        }
        .confirm-btn-danger {
            background: #ff4d4f;
            color: #fff;
        }
        .confirm-btn-danger:hover {
            background: #ff3333;
        }
    </style>
</head>
<body>
<div class="brand-bg text-white pb-3 pt-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="fw-bold fs-5">æˆ‘çš„è®¢å•</div>
                <small>æŸ¥çœ‹ä½ ä¹°åˆ°çš„æ¯ä¸€ä»¶å¥½ç‰©</small>
            </div>
            <a class="text-white small text-decoration-none" th:href="@{/product/list}">å•†å“åˆ—è¡¨</a>
        </div>
    </div>
</div>

<div class="container mt-3 mb-5">
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}">é”™è¯¯ä¿¡æ¯</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${#lists.isEmpty(orders)}" class="text-center text-muted py-5">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¦</div>
        <div>è¿˜æ²¡æœ‰è®¢å•ï¼Œå¿«å»é€›é€›å§ï½</div>
    </div>
    <div th:if="${!#lists.isEmpty(orders)}">
        <!-- æ‰¹é‡åˆ é™¤è¡¨å• -->
        <form th:action="@{/order/deleteBatch}" method="post" id="batchDeleteForm">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                    <label class="form-check-label small text-muted" for="selectAll">å…¨é€‰</label>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger"
                        onclick="openBatchDeleteConfirm()">
                    æ‰¹é‡åˆ é™¤
                </button>
            </div>
        </form>
        <div class="d-flex flex-column gap-3">
            <div class="order-card" th:each="o : ${orders}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <div class="form-check" th:if="${o.status == 2 or o.status == 3}">
                        <input class="form-check-input order-checkbox" type="checkbox" form="batchDeleteForm" name="ids"
                               th:value="${o.id}">
                    </div>
                    <div class="small text-muted">è®¢å•å·ï¼š<span th:text="${o.id}"></span></div>
                </div>
                <span class="badge"
                      th:classappend="${o.status == 0} ? 'bg-warning' : (${o.status == 1} ? 'bg-info' : (${o.status == 2} ? 'bg-success' : 'bg-secondary'))"
                      th:text="${o.status == 0 ? 'å¾…ä»˜æ¬¾' : (o.status == 1 ? 'å·²ä»˜æ¬¾' : (o.status == 2 ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'))}">çŠ¶æ€</span>
            </div>
            <div class="d-flex gap-3 mb-3" th:with="product=${productMap.get(o.productId)}">
                <div th:if="${product != null and product.imageUrl != null}" 
                     style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; background: #f5f5f5; flex-shrink: 0;">
                    <img th:src="${#strings.arraySplit(product.imageUrl, ',')[0]}" 
                         style="width: 100%; height: 100%; object-fit: contain;" alt="å•†å“å›¾">
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1" th:text="${product != null ? product.title : 'å•†å“å·²åˆ é™¤'}">å•†å“æ ‡é¢˜</div>
                    <div class="small text-muted mb-2" th:text="${#temporals.format(o.createTime,'yyyy-MM-dd HH:mm')}">åˆ›å»ºæ—¶é—´</div>
                    <div class="fw-bold text-danger" th:text="'ï¿¥' + ${o.amount}">ä»·æ ¼</div>
                </div>
            </div>
            <div class="d-flex gap-2 justify-content-end align-items-center">
                <a th:href="@{'/order/detail/' + ${o.id}}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹è¯¦æƒ…</a>
                <a th:href="@{'/order/pay/' + ${o.id}}" 
                   class="btn btn-sm btn-warning text-white"
                   th:if="${o.status == 0}">å»æ”¯ä»˜</a>
                <form th:action="@{'/order/complete/' + ${o.id}}" method="post" style="display: inline;"
                      th:if="${o.status == 1}">
                    <button type="submit" class="btn btn-sm btn-success">ç¡®è®¤æ”¶è´§</button>
                </form>
                <form th:action="@{'/order/cancel/' + ${o.id}}" method="post" style="display: inline;"
                      th:if="${o.status == 0}"
                      class="order-cancel-form">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openCancelConfirm(this.closest('form'))">å–æ¶ˆè®¢å•</button>
                </form>
                <form th:action="@{'/order/delete/' + ${o.id}}" method="post" style="display: inline;"
                      th:if="${o.status == 2 or o.status == 3}"
                      class="order-delete-form">
                    <button type="button" class="delete-btn" onclick="openDeleteConfirm(this.closest('form'))">åˆ é™¤</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨é€‰/å–æ¶ˆå…¨é€‰ï¼ˆåªé€‰æ‹©å¯åˆ é™¤çš„è®¢å•ï¼‰
    function toggleSelectAll(checkbox) {
        const checkboxes = document.querySelectorAll('.order-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
        // å¦‚æœå–æ¶ˆå…¨é€‰ï¼Œä¹Ÿè¦å–æ¶ˆå…¨é€‰å¤é€‰æ¡†
        if (!checkbox.checked) {
            checkbox.checked = false;
        } else {
            // å¦‚æœæ‰€æœ‰å¯åˆ é™¤è®¢å•éƒ½è¢«é€‰ä¸­ï¼Œåˆ™å…¨é€‰å¤é€‰æ¡†ä¹Ÿé€‰ä¸­
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkbox.checked = allChecked;
        }
    }

    // ç›‘å¬å•ä¸ªå¤é€‰æ¡†å˜åŒ–ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€
    document.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('order-checkbox')) {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.order-checkbox');
            const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
            }
        }
    });

    // æ‰¹é‡åˆ é™¤ï¼šå¼¹çª—ç¡®è®¤
    let batchCount = 0;
    function openBatchDeleteConfirm() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        if (checked.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¢å•');
            return false;
        }
        batchCount = checked.length;
        const textSpan = document.getElementById('batchDeleteOrderText');
        if (textSpan) {
            textSpan.textContent = 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + batchCount + ' ä¸ªè®¢å•å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚';
        }
        const modal = document.getElementById('batchDeleteOrderModal');
        if (modal) modal.classList.add('show');
        return false;
    }

    function closeBatchDeleteConfirm() {
        const modal = document.getElementById('batchDeleteOrderModal');
        if (modal) modal.classList.remove('show');
        batchCount = 0;
    }

    function confirmBatchDelete() {
        const form = document.getElementById('batchDeleteForm');
        if (form && batchCount > 0) {
            closeBatchDeleteConfirm();
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else if (data.error) {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
                }
            })
            .catch(err => {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', err);
                window.location.reload();
            });
        }
    }
    // åˆ é™¤è®¢å•ç¡®è®¤å¼¹çª—
    let currentDeleteForm = null;
    let currentCancelForm = null;

    window.openDeleteConfirm = function(form) {
        currentDeleteForm = form;
        const modal = document.getElementById('deleteOrderModal');
        if (modal) {
            modal.classList.add('show');
        }
    };

    window.closeDeleteConfirm = function() {
        const modal = document.getElementById('deleteOrderModal');
        if (modal) {
            modal.classList.remove('show');
        }
        currentDeleteForm = null;
    };

    window.confirmDelete = function() {
        if (currentDeleteForm) {
            const formData = new FormData(currentDeleteForm);
            fetch(currentDeleteForm.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.closeDeleteConfirm();
                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                } else if (data.error) {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
                }
            })
            .catch(err => {
                console.error('åˆ é™¤å¤±è´¥:', err);
                // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œå¯èƒ½æ˜¯é‡å®šå‘ï¼Œç›´æ¥åˆ·æ–°é¡µé¢
                window.location.reload();
            });
        }
    };

    // å–æ¶ˆè®¢å•ç¡®è®¤å¼¹çª—
    window.openCancelConfirm = function(form) {
        currentCancelForm = form;
        const modal = document.getElementById('cancelOrderModal');
        if (modal) {
            modal.classList.add('show');
        }
    };

    window.closeCancelConfirm = function() {
        const modal = document.getElementById('cancelOrderModal');
        if (modal) {
            modal.classList.remove('show');
        }
        currentCancelForm = null;
    };

    window.confirmCancel = function() {
        if (currentCancelForm) {
            currentCancelForm.submit();
        }
    };

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'deleteOrderModal') {
            window.closeDeleteConfirm();
        }
        if (e.target && e.target.id === 'cancelOrderModal') {
            window.closeCancelConfirm();
        }
    });
</script>

<!-- åˆ é™¤è®¢å•ç¡®è®¤å¼¹çª— -->
<div id="deleteOrderModal" class="confirm-backdrop">
    <div class="confirm-dialog" onclick="event.stopPropagation()">
        <div class="confirm-title">åˆ é™¤è®¢å•</div>
        <div class="confirm-text">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</div>
        <div class="confirm-actions">
            <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeDeleteConfirm()">å–æ¶ˆ</button>
            <button type="button" class="confirm-btn confirm-btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>

<!-- å–æ¶ˆè®¢å•ç¡®è®¤å¼¹çª— -->
<div id="cancelOrderModal" class="confirm-backdrop">
    <div class="confirm-dialog" onclick="event.stopPropagation()">
        <div class="confirm-title">å–æ¶ˆè®¢å•</div>
        <div class="confirm-text">ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿå–æ¶ˆåå°†æ— æ³•æ¢å¤ã€‚</div>
        <div class="confirm-actions">
            <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeCancelConfirm()">å–æ¶ˆ</button>
            <button type="button" class="confirm-btn confirm-btn-danger" onclick="confirmCancel()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡åˆ é™¤è®¢å•ç¡®è®¤å¼¹çª— -->
<div id="batchDeleteOrderModal" class="confirm-backdrop">
    <div class="confirm-dialog" onclick="event.stopPropagation()">
        <div class="confirm-title">æ‰¹é‡åˆ é™¤è®¢å•</div>
        <div id="batchDeleteOrderText" class="confirm-text">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„è®¢å•å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</div>
        <div class="confirm-actions">
            <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeBatchDeleteConfirm()">å–æ¶ˆ</button>
            <button type="button" class="confirm-btn confirm-btn-danger" onclick="confirmBatchDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>

</body>
</html>
