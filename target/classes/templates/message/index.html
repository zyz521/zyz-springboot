<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>æ¶ˆæ¯ä¸­å¿ƒ - äºŒæ‰‹é±¼å¡˜</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f6f6f6;
        }
        .brand-bg {
            background: linear-gradient(90deg, #ffb300, #ff8a00);
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #fff;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .bottom-nav-item {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .bottom-nav-item span {
            display: block;
        }
        .bottom-nav-item.active {
            color: #ff8a00;
        }
        .bottom-nav-item {
            position: relative;
        }
        .message-badge {
            position: absolute;
            top: -2px;
            right: 50%;
            transform: translateX(20px);
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: #ff4d4f;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #fff;
            font-weight: bold;
            line-height: 18px;
        }
        .message-badge.show {
            display: flex;
        }
        .content-with-nav {
            padding-bottom: 70px;
        }
        .message-card {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.06);
            padding: 14px 16px;
            position: relative;
            border-left: 4px solid #ffb300;
        }
        .message-card.read {
            border-left-color: #e5e5e5;
            opacity: 0.9;
        }
        .message-type {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 12px;
        }
        .badge-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4d4f;
            display: inline-block;
            margin-right: 6px;
        }
        .message-time {
            font-size: 12px;
            color: #999;
        }
        .delete-btn {
            color: #ff6b6b;
            background: none;
            border: none;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .delete-btn:hover {
            background: #fff5f5;
        }
        /* ç°ä»£ç®€çº¦é£æ ¼åˆ é™¤ç¡®è®¤å¼¹çª— */
        .confirm-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .confirm-backdrop.show {
            display: flex;
        }
        .confirm-dialog {
            width: 78%;
            max-width: 360px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            padding: 18px 18px 12px;
        }
        .confirm-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .confirm-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
        }
        .confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .confirm-btn {
            border-radius: 999px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-btn-cancel {
            background: #f5f5f5;
            color: #666;
        }
        .confirm-btn-cancel:hover {
            background: #e8e8e8;
        }
        .confirm-btn-danger {
            background: #ff4d4f;
            color: #fff;
        }
        .confirm-btn-danger:hover {
            background: #ff3333;
        }
    </style>
</head>
<body>
<div class="brand-bg text-white pb-3 pt-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="fw-bold fs-5">æ¶ˆæ¯ä¸­å¿ƒ</div>
                <small>æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥å’Œäº¤æ˜“æ¶ˆæ¯</small>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3 content-with-nav">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <div class="fw-semibold">æˆ‘çš„æ¶ˆæ¯</div>
            <small class="text-muted" th:text="'æœªè¯» ' + ${unreadCount} + ' æ¡'">æœªè¯» 0 æ¡</small>
        </div>
        <form th:if="${unreadCount > 0}" th:action="@{/messages/readAll}" method="post" class="m-0" id="readAllForm">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="readAllBtn">å…¨éƒ¨å·²è¯»</button>
        </form>
    </div>

    <div th:if="${#lists.isEmpty(threads)}" class="bg-white rounded-3 p-4 text-center text-muted">
        æš‚æ— æ¶ˆæ¯
    </div>

    <div class="d-flex flex-column gap-3" th:if="${!#lists.isEmpty(threads)}">
        <div class="message-card" th:each="t : ${threads}"
             th:classappend="${t.unread == 0} ? ' read' : ''">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge-dot" th:if="${t.unread > 0}"></span>
                    <span class="fw-semibold" th:text="${t.postTitle != null ? t.postTitle : (t.productTitle != null ? ('å…³äºå•†å“ï¼š' + t.productTitle) : 'ç³»ç»Ÿæ¶ˆæ¯')}">æ ‡é¢˜</span>
                    <span class="message-type text-white"
                          th:classappend="${t.lastType}=='order' ? ' bg-primary' : (${t.lastType}=='chat' ? ' bg-success' : (${t.lastType}=='pond' ? ' bg-info' : ' bg-warning'))"
                          th:text="${t.lastType == 'order'} ? 'è®¢å•' : (${t.lastType == 'chat'} ? 'èŠå¤©' : (${t.lastType == 'pond'} ? 'é±¼å¡˜' : 'ç³»ç»Ÿ'))">ç³»ç»Ÿ</span>
                </div>
                <span class="message-time" th:text="${#temporals.format(t.lastTime,'MM-dd HH:mm')}">12-12 12:12</span>
            </div>
            <div class="text-muted small">
                <span class="fw-semibold" th:if="${t.otherName != null}" th:text="${t.otherName + 'ï¼š'}">æ¥æºï¼š</span>
                <span th:text="${t.lastContent}">æ¶ˆæ¯å†…å®¹</span>
            </div>
            <div class="mt-2 d-flex justify-content-between align-items-center">
                <div class="small">
                    <a th:if="${t.lastType == 'chat' and t.productId != null and t.otherUserId != null}" 
                       class="text-decoration-none"
                       th:href="@{'/messages/thread'(productId=${t.productId}, with=${t.otherUserId})}">
                        è¿›å…¥å¯¹è¯
                    </a>
                    <a th:if="${t.lastType == 'pond' and t.postId != null}" 
                       class="text-decoration-none"
                       th:href="@{'/pond/post/' + ${t.postId}}">
                        æŸ¥çœ‹åŠ¨æ€
                    </a>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span th:if="${t.unread > 0}" class="badge text-bg-danger" th:text="${t.unread}">æœªè¯»</span>
                    <span th:if="${t.unread == 0}" class="text-muted small">å·²è¯»</span>
                    <form class="message-delete-form" 
                          th:action="@{/messages/delete}" 
                          method="post" 
                          style="display: inline;">
                        <input type="hidden" name="productId" th:value="${t.productId}">
                        <input type="hidden" name="postId" th:value="${t.postId}">
                        <input type="hidden" name="otherUserId" th:value="${t.otherUserId}">
                        <button type="button" class="delete-btn" onclick="openDeleteConfirm(this.closest('form'))">åˆ é™¤</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <a th:href="@{/}" class="text-decoration-none bottom-nav-item">
        <span>ğŸ </span>
        <span>é¦–é¡µ</span>
    </a>
    <a th:href="@{/pond}" class="text-decoration-none bottom-nav-item">
        <span>ğŸŸ</span>
        <span>é±¼å¡˜</span>
    </a>
    <a th:href="@{/product/publish}" class="text-decoration-none bottom-nav-item">
        <span>â•</span>
        <span>å‘å¸ƒ</span>
    </a>
    <a th:href="@{/messages}" class="text-decoration-none bottom-nav-item active" id="messagesNavItem">
        <span>ğŸ’¬</span>
        <span>æ¶ˆæ¯</span>
        <span class="message-badge" id="messageBadge">0</span>
    </a>
    <a th:if="${session.username == null}" th:href="@{/auth/login}" class="text-decoration-none bottom-nav-item">
        <span>ğŸ‘¤</span>
        <span>æˆ‘çš„</span>
    </a>
    <a th:if="${session.username != null}" th:href="@{/user/center}" class="text-decoration-none bottom-nav-item active">
        <span>ğŸ‘¤</span>
        <span>ä¸ªäººä¸­å¿ƒ</span>
    </a>
</div>

<script>
    (function() {
        const currentUserId = [[${currentUserId}]];
        let isPolling = true;
        let lastUnreadCount = [[${unreadCount}]];

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return '';
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return month + '-' + day + ' ' + hours + ':' + minutes;
            } catch (e) {
                return '';
            }
        }

        // æ›´æ–°æœªè¯»æ•°é‡
        function updateUnreadCount(count) {
            const unreadElement = document.querySelector('.text-muted small');
            if (unreadElement) {
                unreadElement.textContent = 'æœªè¯» ' + count + ' æ¡';
            }
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆªæ æ¶ˆæ¯æ•°é‡å¾½ç« 
            const messageBadge = document.getElementById('messageBadge');
            if (messageBadge) {
                if (count > 0) {
                    messageBadge.textContent = count > 99 ? '99+' : count;
                    messageBadge.classList.add('show');
                } else {
                    messageBadge.classList.remove('show');
                }
            }
            
            // æ›´æ–°"å…¨éƒ¨å·²è¯»"æŒ‰é’®æ˜¾ç¤º
            const readAllForm = document.querySelector('form[action*="/messages/readAll"]');
            if (count > 0) {
                if (!readAllForm) {
                    const headerDiv = document.querySelector('.d-flex.justify-content-between.align-items-center.mb-3');
                    if (headerDiv) {
                        const form = document.createElement('form');
                        form.action = '/messages/readAll';
                        form.method = 'post';
                        form.className = 'm-0';
                        form.innerHTML = '<button class="btn btn-sm btn-outline-secondary">å…¨éƒ¨å·²è¯»</button>';
                        headerDiv.appendChild(form);
                    }
                }
            } else {
                if (readAllForm) {
                    readAllForm.remove();
                }
            }
        }

        // æ›´æ–°çº¿ç¨‹åˆ—è¡¨
        function updateThreads(threads) {
            const container = document.querySelector('.d-flex.flex-column.gap-3');
            const emptyDiv = document.querySelector('.bg-white.rounded-3.p-4.text-center.text-muted');
            
            if (threads.length === 0) {
                if (!emptyDiv) {
                    const empty = document.createElement('div');
                    empty.className = 'bg-white rounded-3 p-4 text-center text-muted';
                    empty.textContent = 'æš‚æ— æ¶ˆæ¯';
                    const mainContainer = document.querySelector('.container.mt-3.content-with-nav');
                    if (mainContainer && container) {
                        mainContainer.insertBefore(empty, container);
                        container.style.display = 'none';
                    }
                }
                return;
            }

            if (emptyDiv) {
                emptyDiv.remove();
            }
            if (container) {
                container.style.display = '';
            }

            // æ¸…ç©ºç°æœ‰çº¿ç¨‹å¹¶é‡æ–°æ¸²æŸ“
            if (container) {
                container.innerHTML = '';
                
                threads.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'message-card' + (t.unread === 0 ? ' read' : '');
                    const productTitle = t.productTitle || '';
                    const postTitle = t.postTitle || '';
                    const otherName = t.otherName || '';
                    const lastContent = t.lastContent || '';
                    const lastType = t.lastType || 'system';
                    const unread = t.unread || 0;
                    const productId = t.productId || null;
                    const postId = t.postId || null;
                    const otherUserId = t.otherUserId || null;
                    
                    // ç¡®å®šæ ‡é¢˜æ˜¾ç¤º
                    let titleText = 'ç³»ç»Ÿæ¶ˆæ¯';
                    if (postTitle) {
                        titleText = escapeHtml(postTitle);
                    } else if (productTitle) {
                        titleText = 'å…³äºå•†å“ï¼š' + escapeHtml(productTitle);
                    }
                    
                    // ç¡®å®šæ“ä½œé“¾æ¥
                    let actionLink = '<div></div>';
                    if (lastType === 'chat' && productId && otherUserId) {
                        actionLink = '<div class="small"><a class="text-decoration-none" href="/messages/thread?productId=' + productId + '&with=' + otherUserId + '">è¿›å…¥å¯¹è¯</a></div>';
                    } else if (lastType === 'pond' && postId) {
                        actionLink = '<div class="small"><a class="text-decoration-none" href="/pond/post/' + postId + '">æŸ¥çœ‹åŠ¨æ€</a></div>';
                    }
                    
                    const deleteForm = `
                        <form class="message-delete-form" action="/messages/delete" method="post" style="display: inline;">
                            <input type="hidden" name="productId" value="${productId || ''}">
                            <input type="hidden" name="postId" value="${postId || ''}">
                            <input type="hidden" name="otherUserId" value="${otherUserId || ''}">
                            <button type="button" class="delete-btn" onclick="openDeleteConfirm(this.closest('form'))">åˆ é™¤</button>
                        </form>
                    `;

                    card.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="d-flex align-items-center gap-2">
                                ${unread > 0 ? '<span class="badge-dot"></span>' : ''}
                                <span class="fw-semibold">${titleText}</span>
                                <span class="message-type text-white ${getTypeClass(lastType)}">${getTypeText(lastType)}</span>
                            </div>
                            <span class="message-time">${formatTime(t.lastTime)}</span>
                        </div>
                        <div class="text-muted small">
                            ${otherName ? '<span class="fw-semibold">' + escapeHtml(otherName) + 'ï¼š</span>' : ''}
                            <span>${escapeHtml(lastContent)}</span>
                        </div>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            ${actionLink}
                            <div class="d-flex align-items-center gap-2">
                                ${unread > 0 ? 
                                    '<span class="badge text-bg-danger">' + unread + '</span>' : 
                                    '<span class="text-muted small">å·²è¯»</span>'}
                                ${deleteForm}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        function getTypeClass(type) {
            if (type === 'order') return 'bg-primary';
            if (type === 'chat') return 'bg-success';
            if (type === 'pond') return 'bg-info';
            return 'bg-warning';
        }

        function getTypeText(type) {
            if (type === 'order') return 'è®¢å•';
            if (type === 'chat') return 'èŠå¤©';
            if (type === 'pond') return 'é±¼å¡˜';
            return 'ç³»ç»Ÿ';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è½®è¯¢è·å–æœ€æ–°æ•°æ®
        function pollMessages() {
            if (!isPolling) return;
            fetch('/messages/api')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('è·å–æ¶ˆæ¯å¤±è´¥:', data.error);
                        return;
                    }
                    
                    // æ›´æ–°æœªè¯»æ•°é‡
                    const unreadCount = data.unreadCount || 0;
                    if (unreadCount !== lastUnreadCount) {
                        updateUnreadCount(unreadCount);
                        lastUnreadCount = unreadCount;
                    }
                    
                    // æ›´æ–°çº¿ç¨‹åˆ—è¡¨
                    if (data.threads) {
                        updateThreads(data.threads);
                    }
                })
                .catch(err => {
                    console.error('è½®è¯¢é”™è¯¯:', err);
                });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–çº¢ç‚¹çŠ¶æ€
        updateUnreadCount(lastUnreadCount);

        // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        const pollInterval = setInterval(pollMessages, 2000);

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æš‚åœ/æ¢å¤è½®è¯¢
        document.addEventListener('visibilitychange', function() {
            isPolling = !document.hidden;
            if (isPolling) {
                pollMessages();
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            clearInterval(pollInterval);
        });

        // "å…¨éƒ¨å·²è¯»"æŒ‰é’® AJAX å¤„ç†
        const readAllBtn = document.getElementById('readAllBtn');
        if (readAllBtn) {
            readAllBtn.addEventListener('click', function() {
                fetch('/messages/readAll', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(res => {
                    if (res.ok) {
                        // ç«‹å³æ›´æ–°æœªè¯»æ•°é‡ä¸º0
                        updateUnreadCount(0);
                        lastUnreadCount = 0;
                        // ç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                        setTimeout(pollMessages, 100);
                    }
                })
                .catch(err => {
                    console.error('å…¨éƒ¨å·²è¯»å¤±è´¥:', err);
                });
            });
        }

        // åˆ é™¤æ¶ˆæ¯ç¡®è®¤å¼¹çª—
        let currentDeleteForm = null;

        // å°†åˆ é™¤å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.openDeleteConfirm = function(form) {
            currentDeleteForm = form;
            const modal = document.getElementById('deleteMessageModal');
            if (modal) {
                modal.classList.add('show');
            }
        };

        window.closeDeleteConfirm = function() {
            const modal = document.getElementById('deleteMessageModal');
            if (modal) {
                modal.classList.remove('show');
            }
            currentDeleteForm = null;
        };

        window.confirmDelete = function() {
            if (currentDeleteForm) {
                const formData = new FormData(currentDeleteForm);
                fetch('/messages/delete', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.closeDeleteConfirm();
                        // ç«‹å³åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                        setTimeout(pollMessages, 100);
                    } else if (data.error) {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
                    }
                })
                .catch(err => {
                    console.error('åˆ é™¤å¤±è´¥:', err);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        };

        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'deleteMessageModal') {
                window.closeDeleteConfirm();
            }
        });

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»ï¼ˆå¤„ç†åŠ¨æ€æ·»åŠ çš„å…ƒç´ ï¼‰
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('delete-btn') && e.target.closest('.message-delete-form')) {
                e.preventDefault();
                e.stopPropagation();
                const form = e.target.closest('.message-delete-form');
                if (form) {
                    window.openDeleteConfirm(form);
                }
            }
        });
    })();
</script>

<!-- åˆ é™¤æ¶ˆæ¯ç¡®è®¤å¼¹çª— -->
<div id="deleteMessageModal" class="confirm-backdrop">
    <div class="confirm-dialog" onclick="event.stopPropagation()">
        <div class="confirm-title">åˆ é™¤æ¶ˆæ¯</div>
        <div class="confirm-text">ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</div>
        <div class="confirm-actions">
            <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeDeleteConfirm()">å–æ¶ˆ</button>
            <button type="button" class="confirm-btn confirm-btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
        </div>
    </div>
</div>

</body>
</html>

